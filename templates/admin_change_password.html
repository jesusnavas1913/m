<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cambiar Contraseña - Admin ICFES.IA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 50px auto;
        }

        .card {
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            border: none;
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
        }

        .form-control {
            border-radius: 8px;
            border: 1px solid #ddd;
            padding: 12px 15px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .password-strength {
            margin-top: 10px;
        }

        .strength-bar {
            height: 5px;
            border-radius: 3px;
            transition: all 0.3s;
        }

        .strength-weak {
            background: #dc3545;
            width: 33%;
        }

        .strength-medium {
            background: #ffc107;
            width: 66%;
        }

        .strength-strong {
            background: #28a745;
            width: 100%;
        }

        .requirement {
            font-size: 14px;
            margin: 5px 0;
        }

        .requirement.met {
            color: #28a745;
        }

        .requirement.unmet {
            color: #dc3545;
        }

        .alert {
            border-radius: 8px;
        }

        .input-group-text {
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0">
                    <i class="fas fa-key"></i> Cambiar Contraseña de Administrador
                </h3>
                <p class="mb-0 mt-2" style="font-size: 14px;">Actualiza tu contraseña con seguridad</p>
            </div>
            <div class="card-body p-4">
                <div id="alert-container"></div>

                <form id="change-password-form">
                    <!-- Verificación de Identidad -->
                    <div class="mb-4">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-shield-alt"></i> Verificación de Identidad
                        </h5>

                        <div class="mb-3">
                            <label for="cedula" class="form-label">
                                <i class="fas fa-id-card"></i> Cédula
                            </label>
                            <input type="text" class="form-control" id="cedula" name="cedula" required>
                            <small class="text-muted">Ingresa tu cédula para verificar tu identidad</small>
                        </div>

                        <div class="mb-3">
                            <label for="current_password" class="form-label">
                                <i class="fas fa-lock"></i> Contraseña Actual
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="current_password"
                                    name="current_password" required>
                                <span class="input-group-text" onclick="togglePassword('current_password', 'eye1')">
                                    <i class="fas fa-eye" id="eye1"></i>
                                </span>
                            </div>
                            <small class="text-muted">Ingresa tu contraseña actual para confirmar</small>
                        </div>
                    </div>

                    <hr>

                    <!-- Nueva Contraseña -->
                    <div class="mb-4">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-key"></i> Nueva Contraseña
                        </h5>

                        <div class="mb-3">
                            <label for="new_password" class="form-label">
                                <i class="fas fa-lock"></i> Nueva Contraseña
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="new_password" name="new_password"
                                    required>
                                <span class="input-group-text" onclick="togglePassword('new_password', 'eye2')">
                                    <i class="fas fa-eye" id="eye2"></i>
                                </span>
                            </div>

                            <!-- Indicador de Fuerza -->
                            <div class="password-strength">
                                <div class="strength-bar" id="strength-bar"></div>
                                <small id="strength-text" class="text-muted"></small>
                            </div>

                            <!-- Requisitos -->
                            <div class="mt-3">
                                <small class="text-muted d-block mb-2"><strong>Requisitos de seguridad:</strong></small>
                                <div class="requirement unmet" id="req-length">
                                    <i class="fas fa-times-circle"></i> Mínimo 8 caracteres
                                </div>
                                <div class="requirement unmet" id="req-upper">
                                    <i class="fas fa-times-circle"></i> Al menos 1 letra mayúscula
                                </div>
                                <div class="requirement unmet" id="req-lower">
                                    <i class="fas fa-times-circle"></i> Al menos 1 letra minúscula
                                </div>
                                <div class="requirement unmet" id="req-number">
                                    <i class="fas fa-times-circle"></i> Al menos 1 número
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="confirm_password" class="form-label">
                                <i class="fas fa-lock"></i> Confirmar Nueva Contraseña
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="confirm_password"
                                    name="confirm_password" required>
                                <span class="input-group-text" onclick="togglePassword('confirm_password', 'eye3')">
                                    <i class="fas fa-eye" id="eye3"></i>
                                </span>
                            </div>
                            <small class="text-muted" id="match-text"></small>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save"></i> Cambiar Contraseña
                        </button>
                        <a href="/admin/dashboard" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Volver al Dashboard
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Toggle password visibility
        function togglePassword(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Validar fuerza de contraseña en tiempo real
        document.getElementById('new_password').addEventListener('input', function () {
            const password = this.value;
            const strengthBar = document.getElementById('strength-bar');
            const strengthText = document.getElementById('strength-text');

            // Verificar requisitos
            const hasLength = password.length >= 8;
            const hasUpper = /[A-Z]/.test(password);
            const hasLower = /[a-z]/.test(password);
            const hasNumber = /[0-9]/.test(password);

            // Actualizar requisitos visuales
            updateRequirement('req-length', hasLength);
            updateRequirement('req-upper', hasUpper);
            updateRequirement('req-lower', hasLower);
            updateRequirement('req-number', hasNumber);

            // Calcular fuerza
            let strength = 0;
            if (hasLength) strength++;
            if (hasUpper) strength++;
            if (hasLower) strength++;
            if (hasNumber) strength++;

            // Actualizar barra de fuerza
            strengthBar.className = 'strength-bar';
            if (strength <= 2) {
                strengthBar.classList.add('strength-weak');
                strengthText.textContent = 'Contraseña débil';
                strengthText.style.color = '#dc3545';
            } else if (strength === 3) {
                strengthBar.classList.add('strength-medium');
                strengthText.textContent = 'Contraseña media';
                strengthText.style.color = '#ffc107';
            } else {
                strengthBar.classList.add('strength-strong');
                strengthText.textContent = 'Contraseña fuerte';
                strengthText.style.color = '#28a745';
            }
        });

        // Verificar coincidencia de contraseñas
        document.getElementById('confirm_password').addEventListener('input', function () {
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = this.value;
            const matchText = document.getElementById('match-text');

            if (confirmPassword === '') {
                matchText.textContent = '';
            } else if (newPassword === confirmPassword) {
                matchText.textContent = '✓ Las contraseñas coinciden';
                matchText.style.color = '#28a745';
            } else {
                matchText.textContent = '✗ Las contraseñas no coinciden';
                matchText.style.color = '#dc3545';
            }
        });

        function updateRequirement(id, met) {
            const element = document.getElementById(id);
            if (met) {
                element.classList.remove('unmet');
                element.classList.add('met');
                element.innerHTML = element.innerHTML.replace('fa-times-circle', 'fa-check-circle');
            } else {
                element.classList.remove('met');
                element.classList.add('unmet');
                element.innerHTML = element.innerHTML.replace('fa-check-circle', 'fa-times-circle');
            }
        }

        // Enviar formulario
        document.getElementById('change-password-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const cedula = document.getElementById('cedula').value;
            const currentPassword = document.getElementById('current_password').value;
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;

            // Validaciones del lado del cliente
            if (newPassword !== confirmPassword) {
                showAlert('Las contraseñas no coinciden', 'danger');
                return;
            }

            if (newPassword.length < 8) {
                showAlert('La contraseña debe tener al menos 8 caracteres', 'danger');
                return;
            }

            if (!/[A-Z]/.test(newPassword)) {
                showAlert('La contraseña debe contener al menos una mayúscula', 'danger');
                return;
            }

            if (!/[a-z]/.test(newPassword)) {
                showAlert('La contraseña debe contener al menos una minúscula', 'danger');
                return;
            }

            if (!/[0-9]/.test(newPassword)) {
                showAlert('La contraseña debe contener al menos un número', 'danger');
                return;
            }

            if (newPassword === currentPassword) {
                showAlert('La nueva contraseña debe ser diferente a la actual', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/admin/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        cedula: cedula,
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(data.message, 'success');
                    setTimeout(() => {
                        window.location.href = '/admin/dashboard';
                    }, 2000);
                } else {
                    showAlert(data.message, 'danger');
                }
            } catch (error) {
                showAlert('Error de conexión. Intente nuevamente.', 'danger');
            }
        });

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
    </script>
</body>

</html>